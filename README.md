# File-based workflows for the DoIt automation tool
The goal of this project is to create a library of file collection and mapping classes that provide actions, file_deps and targets to [DoIt][1] tasks. The mappers allow specifying tasks that rely on globs and file name mapping rather than having to explicity name every file dependency and every target. This is for text and data processing tasks that happen in several stages where data is converted, enriched, filtered and merged.

The classes are inspired by concepts in the popular [Ant][2] and [Ruffus][3] build tools.

## FileMapper usage
A typical DoIt Python task calls a function with a list of target files:

```python
def task_convert_to_json():
    def process_files(targets):
        for t in target:
            # read target, map to json, write to individual json file
    return {
        "actions": [process_files],
        "targets": ["file1.csv", "file2.csv"]
    }
```

A file mapper can produce a "source" file for every target file. Consider the easiest case where you want to create a new, processed file for every source file:

```python
def task_convert_to_json():
    def process_file(in_file, out_file):
        with open(in_file, "r") as _in, open(out_file, "w") as _out:
            # read from _in, process data, write to _out
    mapper = GlobMapper("src/*.csv", process_file, pattern="dst/*.json")
    return mapper.get_task()
```

You must always provide a callback to the mapper that receives one source file and one target file. This callback will be called for every source/target pair of the mapper.

The `get_task` method of the mapper will return the task data with an action (generated by the mapper using the callback), targets and file dependencies. If you want to have additional task parameters like `uptodate`, `basename`, `title`, etc. you can provide them as a dict parameter to `get_task`:

```python
mapper.get_task({"basename":"foo"})
```

### Mapper constructor parameters
The following parameters are common for all mappers
- `src`: Designate which source files should be selected. Always a glob path to be used by [`Pathlib`][4].
- `callback`: A callable with `input_file`, `output_file` parameters.
- `dir`: Operating directory. The path expressions in `from` and `to` are relative to this directory. Defaults to `.` (current directory).
- `file_dep`: If true, `get_task` creates `file_dep` with the source files from the mapper. For most mappers it is true.
- `follow_symlinks`: If set to false, only files are mapped. Defaults to true.

## Types of Mappers
### IdentityMapper
This simple mapper only has a `src` parameter. It returns all files and has no `file_dep`.
### GlobMapper
### RegexMapper
### MergeMapper

## TODO
- Support arrays of glob strings in the `from` parameter.

[1]: http://pydoit.org/ 
[2]: http://ant.apache.org/
[3]: http://www.ruffus.org.uk/
[4]: https://pathlib.readthedocs.org/